<mxfile host="app.diagrams.net" modified="2025-11-12T00:00:00.000Z" agent="draw.io" version="22.1.11">
  <diagram name="KVM Token Flow" id="kvm-token-flow">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="1654" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="KVM Remote Console - Token Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="334" y="40" width="500" height="40" as="geometry" />
        </mxCell>
        
        <!-- Step 1: User Credentials -->
        <mxCell id="step1" value="&lt;b&gt;1. User Credentials&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="484" y="120" width="200" height="60" as="geometry" />
        </mxCell>
        
        <!-- Arrow 1 -->
        <mxCell id="arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step1" target="step2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow1-label" value="Authenticate" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow1">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 2: Keycloak JWT -->
        <mxCell id="step2" value="&lt;b&gt;2. Keycloak JWT&lt;/b&gt;&lt;br&gt;(User Token)&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;Lifetime: 5-30 minutes&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="484" y="220" width="200" height="80" as="geometry" />
        </mxCell>
        
        <!-- Arrow 2 -->
        <mxCell id="arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step2" target="step3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow2-label" value="API Request with JWT" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow2">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 3: apiv2 validates -->
        <mxCell id="step3" value="&lt;b&gt;3. apiv2 (infra-core)&lt;/b&gt;&lt;br&gt;✓ Validates Keycloak JWT&lt;br&gt;✓ Extracts tenant ID&lt;br&gt;✓ Checks RBAC permissions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=13;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="464" y="340" width="240" height="100" as="geometry" />
        </mxCell>
        
        <!-- Arrow 3 -->
        <mxCell id="arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step3" target="step4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow3-label" value="PATCH /compute/hosts/{id}" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow3">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 4: inventory update -->
        <mxCell id="step4" value="&lt;b&gt;4. inventory (infra-core)&lt;/b&gt;&lt;br&gt;UPDATE hosts SET&lt;br&gt;  desired_kvm_state = 'REQUESTED'" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=13;align=left;spacingLeft=10;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="464" y="480" width="240" height="90" as="geometry" />
        </mxCell>
        
        <!-- Arrow 4 -->
        <mxCell id="arrow4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step4" target="step5">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow4-label" value="State mismatch detected" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow4">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 5: dm-manager reconciler -->
        <mxCell id="step5" value="&lt;b&gt;5. dm-manager (infra-external)&lt;/b&gt;&lt;br&gt;Reconciler Loop:&lt;br&gt;  desired != current → handleKVMChange()" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=13;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="464" y="610" width="240" height="90" as="geometry" />
        </mxCell>
        
        <!-- Arrow 5 -->
        <mxCell id="arrow5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step5" target="step6">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow5-label" value="GET /api/v1/authorize/redirection/{guid}&lt;br&gt;Header: ActiveProjectId: tenant-id" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=11;" vertex="1" connectable="0" parent="arrow5">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-20" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 6: MPS generates token -->
        <mxCell id="step6" value="&lt;b&gt;6. MPS (Management Presence Server)&lt;/b&gt;&lt;br&gt;✓ Validates device exists&lt;br&gt;✓ Generates MPS JWT (HS256)&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;Lifetime: 30 minutes&lt;/font&gt;&lt;br&gt;Claims: {tenantId, deviceId, exp}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=13;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="444" y="740" width="280" height="110" as="geometry" />
        </mxCell>
        
        <!-- Arrow 6 -->
        <mxCell id="arrow6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step6" target="step7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow6-label" value="Response: {&quot;token&quot;: &quot;eyJ...&quot;}" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow6">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 7: dm-manager stores -->
        <mxCell id="step7" value="&lt;b&gt;7. dm-manager → inventory&lt;/b&gt;&lt;br&gt;UPDATE hosts SET&lt;br&gt;  current_kvm_state = 'ACTIVE',&lt;br&gt;  kvm_session_token = 'eyJ...',&lt;br&gt;  kvm_console_url = 'https://...',&lt;br&gt;  kvm_expires_at = ..." style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;align=left;spacingLeft=10;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="444" y="890" width="280" height="120" as="geometry" />
        </mxCell>
        
        <!-- Arrow 7 -->
        <mxCell id="arrow7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step7" target="step8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow7-label" value="GET /compute/hosts/{id}" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow7">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 8: orch-cli/web-ui retrieves -->
        <mxCell id="step8" value="&lt;b&gt;8. orch-cli / web-ui&lt;/b&gt;&lt;br&gt;Retrieves Console URL:&lt;br&gt;&lt;font face=&quot;Courier New&quot;&gt;https://web-ui.../kvm?session=eyJ...&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=13;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="444" y="1050" width="280" height="90" as="geometry" />
        </mxCell>
        
        <!-- Arrow 8 -->
        <mxCell id="arrow8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step8" target="step9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow8-label" value="User opens Console URL in browser" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow8">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 9: Browser WebSocket -->
        <mxCell id="step9" value="&lt;b&gt;9. Browser → MPS WebSocket&lt;/b&gt;&lt;br&gt;WSS /relay/webrelay.ashx&lt;br&gt;Header: Sec-WebSocket-Protocol: eyJ...&lt;br&gt;&lt;font color=&quot;#666666&quot;&gt;(MPS JWT token for authentication)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=13;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="444" y="1180" width="280" height="100" as="geometry" />
        </mxCell>
        
        <!-- Arrow 9 -->
        <mxCell id="arrow9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step9" target="step10">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow9-label" value="Token validated" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow9">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 10: MPS validates -->
        <mxCell id="step10" value="&lt;b&gt;10. MPS Validates Token&lt;/b&gt;&lt;br&gt;✓ JWT signature valid&lt;br&gt;✓ Token not expired (exp &gt; now)&lt;br&gt;✓ deviceId matches host param&lt;br&gt;✓ tenantId matches device owner" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=13;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="444" y="1320" width="280" height="110" as="geometry" />
        </mxCell>
        
        <!-- Arrow 10 -->
        <mxCell id="arrow10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;" edge="1" parent="1" source="step10" target="step11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow10-label" value="Establish KVM redirection (port 16994)" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;" vertex="1" connectable="0" parent="arrow10">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 11: AMT Connection -->
        <mxCell id="step11" value="&lt;b&gt;11. AMT Connection Established&lt;/b&gt;&lt;br&gt;MPS ↔ AMT Device (KVM stream)&lt;br&gt;Video OUT + Keyboard/Mouse IN" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=14;align=center;" vertex="1" parent="1">
          <mxGeometry x="444" y="1470" width="280" height="90" as="geometry" />
        </mxCell>
        
        <!-- Arrow 11 -->
        <mxCell id="arrow11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;endArrow=block;endFill=1;strokeColor=#00CC00;" edge="1" parent="1" source="step11" target="step12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="arrow11-label" value="Live console stream" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=12;fontColor=#009900;" vertex="1" connectable="0" parent="arrow11">
          <mxGeometry x="-0.2" y="2" relative="1" as="geometry">
            <mxPoint x="2" y="-12" as="offset" />
          </mxGeometry>
        </mxCell>
        
        <!-- Step 12: User interacts -->
        <mxCell id="step12" value="&lt;b&gt;✅ 12. User Interacts with AMT Console&lt;/b&gt;&lt;br&gt;&lt;br&gt;Remote keyboard, mouse, and display access&lt;br&gt;BIOS configuration, OS troubleshooting, recovery" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d4edda;strokeColor=#28a745;fontSize=14;align=center;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="424" y="1600" width="320" height="100" as="geometry" />
        </mxCell>
        
        <!-- Side annotations -->
        <mxCell id="note1" value="&lt;b&gt;Keycloak JWT&lt;/b&gt;&lt;br&gt;• User authentication&lt;br&gt;• Long-lived (5-30 min)&lt;br&gt;• Contains tenant claims" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;size=15;align=left;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="200" width="180" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="note2" value="&lt;b&gt;MPS JWT&lt;/b&gt;&lt;br&gt;• Device session auth&lt;br&gt;• Short-lived (30 min)&lt;br&gt;• Device-specific&lt;br&gt;• Tenant-isolated" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#ffe6cc;strokeColor=#d79b00;size=15;align=left;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="740" width="180" height="110" as="geometry" />
        </mxCell>
        
        <mxCell id="note3" value="&lt;b&gt;Two-Token System&lt;/b&gt;&lt;br&gt;• Keycloak: User identity&lt;br&gt;• MPS: Device session&lt;br&gt;• Separation of concerns&lt;br&gt;• Enhanced security" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#f8d7da;strokeColor=#c82333;size=15;align=left;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="900" y="400" width="180" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="note4" value="&lt;b&gt;Infrastructure&lt;/b&gt;&lt;br&gt;• IngressRoute: amt-api-mps&lt;br&gt;• WebSocket upgrades&lt;br&gt;• JWT validation middleware&lt;br&gt;• No new components!" style="shape=note;whiteSpace=wrap;html=1;backgroundOutline=1;darkOpacity=0.05;fillColor=#d4edda;strokeColor=#28a745;size=15;align=left;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="900" y="1180" width="180" height="100" as="geometry" />
        </mxCell>
        
        <!-- Legend -->
        <mxCell id="legend-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="80" y="1450" width="280" height="180" as="geometry" />
        </mxCell>
        <mxCell id="legend-title" value="&lt;b&gt;Component Legend&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="90" y="1460" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend1" value="Authentication" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="90" y="1495" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend2" value="Token Generation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="90" y="1535" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend3" value="API/Gateway" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="230" y="1495" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend4" value="Database" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="230" y="1535" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend5" value="Reconciler/Service" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="90" y="1575" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="legend6" value="Success State" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d4edda;strokeColor=#28a745;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="230" y="1575" width="120" height="30" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
