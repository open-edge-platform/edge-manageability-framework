# SPDX-FileCopyrightText: 2025 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

# Kyverno policies to block use of Bitnami images.
block_bitnami_images:
  FailureAction: "Enforce"
  rules:
    - name: block_bitnami_images
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
      validate:
        message: "Bitnami images (bitnami/*) are not allowed."
        deny:
          conditions:
            any:
              # For Pod resources
              - key: "{{ request.object.kind == 'Pod' && request.object.spec.containers[?contains(image, 'bitnami/')] | length(@) }}"
                operator: GreaterThan
                value: 0
              - key: "{{ request.object.kind == 'Pod' && request.object.spec.initContainers[?contains(image, 'bitnami/')] | length(@) }}"
                operator: GreaterThan
                value: 0
              # For other workload resources (Deployment, StatefulSet, etc.)
              - key: "{{ request.object.kind != 'Pod' && request.object.spec.template.spec.containers[?contains(image, 'bitnami/')] | length(@) }}"
                operator: GreaterThan
                value: 0
              - key: "{{ request.object.kind != 'Pod' && request.object.spec.template.spec.initContainers[?contains(image, 'bitnami/')] | length(@) }}"
                operator: GreaterThan
                value: 0

require_ro_rootfs:
  FailureAction: "Audit"
  exclude:
    namespaces: []
    names: []

# Define namespace & pod (including wildcard) exceptions for restricted cluster policy.
# These are used for 1st party pods. Exceptions for 3rd party namespaces are defined in cluster policy.
restrictedPolicyOrch:
  - namespace: "orch-iam"
    names:
      - "iam-umbrella-nexus-api-gw-*"
  - namespace: "orch-platform"
    names:
      - "orchestrator-observability-opentelemetry-collector*"
      - "orchestrator-observability-opentelemetry-collector-daemonset-agent*"
      - "loki-backend*"
      - "orchestrator-observability-loki-gateway*"
      - "orchestrator-observability-loki-results-cache*"
      - "orchestrator-observability-loki-chunks-cache*"
      - "orchestrator-observability-minio*"
      - "orchestrator-observability-mimir-make-minio-buckets*"
      - "adm-secret*"
  - namespace: "orch-infra"
    names:
      - "alerting-monitor-alertmanager*"
      - "onboarding-manager*"
      - "edgenode-observability-mimir-make-minio-buckets*"
      - "loki-backend*"
      - "edgenode-observability-loki-gateway*"
      - "edgenode-observability-loki-results-cache*"
      - "edgenode-observability-loki-chunks-cache*"
      - "edgenode-observability-opentelemetry-collector*"
      - "edgenode-observability-minio*"
      - "dkam*"
      - "rps*"  # Added to allow OpenDMT RPC-RPS traffic, which fails due to missing JWT token.
      - "pxe-server*"  # Needs host networking and special capabilities, on-prem only.
  - namespace: "capi-operator-system"
    names:
      - "capi-operator-cluster-api-operator*"
