# SPDX-FileCopyrightText: 2025 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

# Keycloak Configuration - CodeCentric Chart
# Modular configuration for production deployment

#################################
# IDENTITY & NAMING
#################################
## Ensure service name compatibility with existing consumers
fullnameOverride: "platform-keycloak"

#################################
# CONTAINER & IMAGE
#################################
image:
  repository: quay.io/keycloak/keycloak
  tag: "26.0.7"
  pullPolicy: IfNotPresent

#################################
# SECURITY CONFIGURATION
#################################
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  allowPrivilegeEscalation: false
  capabilities:
    drop: ["ALL"]
  seccompProfile:
    type: "RuntimeDefault"

podSecurityContext:
  fsGroup: 1000

podLabels:
  sidecar.istio.io/inject: "false"

#################################
# NETWORK & SERVICE
#################################
service:
  type: ClusterIP
  httpPort: 8080

networkPolicy:
  enabled: false

#################################
# KEYCLOAK CONFIGURATION
#################################
## Startup configuration
command:
  - "/opt/keycloak/bin/kc.sh"

args:
  - "start"
  - "--optimized"
  - "--spi-login-protocol-openid-connect-legacy-logout-redirect-uri=true"
  - "--spi-brute-force-protector-default-brute-force-detector-allow-concurrent-requests=true"

## Environment variables for Keycloak configuration
extraEnv: |
  # Admin credentials
  - name: KEYCLOAK_ADMIN
    value: "admin"
  - name: KEYCLOAK_ADMIN_PASSWORD
    valueFrom:
      secretKeyRef:
        name: platform-keycloak
        key: admin-password
  
  # HTTP/HTTPS configuration
  - name: KC_HOSTNAME_STRICT
    value: "false"
  - name: KC_HOSTNAME_STRICT_HTTPS
    value: "false"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_PROXY
    value: "passthrough"
  
  # Feature enablement
  - name: KC_HEALTH_ENABLED
    value: "true"
  - name: KC_METRICS_ENABLED
    value: "true"
  
  # Database configuration
  - name: KC_DB
    value: "postgres"
  - name: KC_DB_URL_HOST
    valueFrom:
      secretKeyRef:
        name: platform-keycloak-local-postgresql
        key: PGHOST
  - name: KC_DB_URL_PORT
    valueFrom:
      secretKeyRef:
        name: platform-keycloak-local-postgresql
        key: PGPORT
  - name: KC_DB_URL_DATABASE
    valueFrom:
      secretKeyRef:
        name: platform-keycloak-local-postgresql
        key: PGDATABASE
  - name: KC_DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: platform-keycloak-local-postgresql
        key: PGUSER
  - name: KC_DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: platform-keycloak-local-postgresql
        key: PGPASSWORD

#################################
# DATABASE CONFIGURATION
#################################
database:
  vendor: postgres
  existingSecret: platform-keycloak-local-postgresql

dbchecker:
  enabled: true

#################################
# HEALTH & MONITORING
#################################
livenessProbe:
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:  
  httpGet:
    path: /realms/master
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

metrics:
  enabled: true

health:
  enabled: true

#################################
# CLUSTERING & CACHE
#################################
cache:
  stack: default

#################################
# STORAGE & CONFIGURATION
#################################
## Volume for realm configuration import
extraVolumes: |
  - name: keycloak-config
    configMap:
      name: platform-keycloak-config