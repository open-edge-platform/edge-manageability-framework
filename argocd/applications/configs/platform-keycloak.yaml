# SPDX-FileCopyrightText: 2025 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

# Keycloak Configuration - CodeCentric Chart
# Modular configuration for production deployment

#################################
# IDENTITY & NAMING
#################################
## Ensure service name compatibility with existing consumers
fullnameOverride: "platform-keycloak"

#################################
# CONTAINER & IMAGE
#################################
image:
  repository: quay.io/keycloak/keycloak
  tag: "26.0.7"
  pullPolicy: IfNotPresent

#################################
# SECURITY CONFIGURATION
#################################
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  allowPrivilegeEscalation: false
  capabilities:
    drop: ["ALL"]
  seccompProfile:
    type: "RuntimeDefault"

podSecurityContext:
  fsGroup: 1000

podLabels:
  sidecar.istio.io/inject: "false"

#################################
# NETWORK & SERVICE
#################################
service:
  type: ClusterIP
  httpPort: 8080

networkPolicy:
  enabled: false

#################################
# KEYCLOAK CONFIGURATION
#################################
## Startup configuration
command:
  - "/opt/keycloak/bin/kc.sh"

args:
  - "start"
  - "--spi-login-protocol-openid-connect-legacy-logout-redirect-uri=true"
  - "--spi-brute-force-protector-default-brute-force-detector-allow-concurrent-requests=true"

## Environment variables for Keycloak configuration
extraEnv: |
  - name: JAVA_OPTS_APPEND
    value: >-
      -Djgroups.dns.query=platform-keycloak-headless.orch-platform.svc.cluster.local
  - name: KC_HTTP_RELATIVE_PATH
    value: "/"
  - name: KC_CACHE
    value: "ispn"
  - name: KC_CACHE_STACK
    value: "kubernetes"
  # Admin credentials
  - name: KC_BOOTSTRAP_ADMIN_USERNAME
    value: "admin"
  - name: KC_BOOTSTRAP_ADMIN_PASSWORD
    valueFrom:
      secretKeyRef:
        name: platform-keycloak
        key: admin-password
  # HTTP/HTTPS configuration
  - name: KC_HOSTNAME_STRICT
    value: "false"
  # HTTP/HTTPS configuration
  - name: KC_HOSTNAME_STRICT_HTTPS
    value: "false"
  - name: KC_HTTP_ENABLED
    value: "true"
  - name: KC_PROXY
    value: "passthrough"
  # Feature enablement
  - name: KC_HEALTH_ENABLED
    value: "true"
  - name: KC_METRICS_ENABLED
    value: "true"
  # Database username from secret (password is handled by database: section)
  - name: KC_DB_USERNAME
    valueFrom:
      secretKeyRef:
        name: platform-keycloak-local-postgresql
        key: PGUSER
  # Proxy configuration
  - name: HTTPS_PROXY
    value: "http://proxy-dmz.intel.com:912"
  - name: HTTP_PROXY
    value: "http://proxy-dmz.intel.com:912"
  - name: NO_PROXY
    value: "localhost,svc,cluster.local,default,internal,caas.intel.com,certificates.intel.com,localhost,127.0.0.0/8,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,169.254.169.254,orch-platform,orch-app,orch-cluster,orch-infra,orch-database,cattle-system,orch-secret,s3.amazonaws.com,s3.us-west-2.amazonaws.com,ec2.us-west-2.amazonaws.com,eks.amazonaws.com,elb.us-west-2.amazonaws.com,dkr.ecr.us-west-2.amazonaws.com,espd.infra-host.com,pid.infra-host.com,espdqa.infra-host.com,argocd-repo-server"

#################################
# DATABASE CONFIGURATION
#################################
database:
  vendor: postgres
  hostname: postgresql.orch-database.svc.cluster.local
  port: 5432
  database: orch-platform-platform-keycloak
  existingSecret: platform-keycloak-local-postgresql
  existingSecretKey: PGPASSWORD

dbchecker:
  enabled: true
  securityContext:
    seccompProfile:
      type: RuntimeDefault
    capabilities:
      drop:
        - ALL

#################################
# HEALTH & MONITORING
#################################
livenessProbe: |
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3
readinessProbe: |
  httpGet:
    path: /realms/master
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
startupProbe: |
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 15
  periodSeconds: 5
  timeoutSeconds: 1
  failureThreshold: 60
cache:
  stack: kubernetes
