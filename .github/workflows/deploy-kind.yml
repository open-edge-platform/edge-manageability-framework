name: Run Deploy Orchestrator on Kind Every Hour

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 30 minutes (UTC)
  push:
    branches:
      - kind-stability
  workflow_dispatch:

concurrency:
  group: deploy-kind-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-kind:
    if: github.ref == 'refs/heads/kind-stability'
    runs-on: ubuntu-24.04-16core-64GB

    env:
      ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: kind-stability
          persist-credentials: false

      - name: Deploy Kind Orchestrator
        id: deploy-kind-orchestrator
        uses: ./.github/actions/deploy_kind
        timeout-minutes: 45
        with:
          orch_version: ${{ github.event.pull_request.head.sha || github.sha }}
          orch_password: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
          docker_username: ${{ secrets.SYS_DOCKERHUB_USERNAME }}
          docker_password: ${{ secrets.SYS_DOCKERHUB_RO }}
          token: ${{ secrets.SYS_ORCH_GITHUB }}
          deployment_type: all

      - name: Collect pod logs
        if: always()
        uses: ./.github/actions/collect_diagnostics
        timeout-minutes: 15
