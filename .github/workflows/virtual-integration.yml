# SPDX-FileCopyrightText: 2025 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

name: Virtual Integration

on:
  # Allow manually triggering the workflow
  workflow_dispatch: {}
  # Run on all commits that are pushed to all branches
  push:
    branches:
      - main
      - main-pass-validation

  # Trigger workflow on PRs to all branches
  pull_request:
    branches:
      - "*"
    types:
      - opened
      - synchronize
      - reopened
  # Trigger workflow when enqueued to a merge group
  merge_group:

# Only run at most 1 workflow concurrently per PR, unlimited for branches
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions: {}

jobs:
  pre-merge:
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    uses: open-edge-platform/orch-ci/.github/workflows/pre-merge.yml@c4b86434962d13f65fd7b16a33e9eecfd5849a64  # 0.1.56
    with:
      run_version_check: false
      run_build: false
      run_lint: false
      run_test: false
      bootstrap_tools: ""
      trivy_config_path: trivy.yaml

  check-changed-files:
    permissions:
      contents: read
    name: Filter list of changed files
    runs-on: ubuntu-latest
    outputs:
      ci: ${{ contains(steps.check-files.outputs.changed_files, '.github/workflows') || contains(steps.check-files.outputs.changed_files, '.github/actions') }}
      go: ${{ contains(steps.check-files.outputs.changed_files, '.go') || contains(steps.check-files.outputs.changed_files, '.mod') || contains(steps.check-files.outputs.changed_files, '.sum') }}
      markdown: ${{ contains(steps.check-files.outputs.changed_files, '.md') || contains(steps.check-files.outputs.changed_files, '.markdown') || contains(steps.check-files.outputs.changed_files, '.mdx') }}
      orch: ${{ contains(steps.check-files.outputs.changed_files, 'argocd') || contains(steps.check-files.outputs.changed_files, 'bootstrap') || contains(steps.check-files.outputs.changed_files, 'installer') || contains(steps.check-files.outputs.changed_files, 'internal') || contains(steps.check-files.outputs.changed_files, 'mage') || contains(steps.check-files.outputs.changed_files, 'node') || contains(steps.check-files.outputs.changed_files, 'router') || contains(steps.check-files.outputs.changed_files, 'tools') || contains(steps.check-files.outputs.changed_files, 'e2e-tests') || contains(steps.check-files.outputs.changed_files, 'VERSION') || contains(steps.check-files.outputs.changed_files, 'orch-configs') }}
      on-prem: ${{ contains(steps.check-files.outputs.changed_files, 'on-prem-installers') || contains(steps.check-files.outputs.changed_files, 'terraform') }}
      onboarding: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/applications/templates/infra-') || contains(steps.check-files.outputs.changed_files, 'argocd/applications/values.yaml') }}
      shell: ${{ contains(steps.check-files.outputs.changed_files, '.sh') || contains(steps.check-files.outputs.changed_files, '.bash') }}
      terraform: ${{ contains(steps.check-files.outputs.changed_files, '.hcl') || contains(steps.check-files.outputs.changed_files, '.tf') || contains(steps.check-files.outputs.changed_files, '.tfvars') }}
      yaml: ${{ contains(steps.check-files.outputs.changed_files, '.yaml') || contains(steps.check-files.outputs.changed_files, '.yml') }}
      helm: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/') || contains(steps.check-files.outputs.changed_files, 'argocd-internal/') }}
      test-automation: ${{ contains(steps.check-files.outputs.changed_files, '.test-dependencies.yaml') }}
      only_design_proposals: ${{ steps.only-design-proposals.outputs.only_design_proposals }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Discover Changed Files
        id: check-files
        uses: open-edge-platform/orch-ci/discover-changed-files@main  # zizmor: ignore[unpinned-uses]
        with:
          project_folder: "."

      - name: Calculate only_design_proposals
        id: only-design-proposals
        run: |
          files="${{ steps.check-files.outputs.changed_files }}"
          only_design=true
          # Remove brackets and quotes, then split on comma
          clean_files=$(echo "$files" | sed 's/\[//;s/\]//;s/"//g')
          for file in $(echo "$clean_files" | tr ',' '\n'); do
            file=$(echo $file | xargs) # trim whitespace
            if [[ $file != design-proposals/* ]]; then
              only_design=false
              break
            fi
          done
          echo "only_design=$only_design"
          echo "only_design_proposals=$only_design" >> $GITHUB_OUTPUT

 
  deploy-kind:
    permissions:
      contents: read
    name: Deploy Kind Orchestrator and run tests
    runs-on: ubuntu-24.04-16core-64GB
    timeout-minutes: 90
    env:
      ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Checkout virtual-edge-node repo
        uses: actions/checkout@v4
        with:
          repository: open-edge-platform/virtual-edge-node
          ref: pico/1.5.6
          path: edge-manageability-framework/virtual-edge-node
          persist-credentials: false

      - name: Checkout orch-cli repo
        uses: actions/checkout@v4
        with:
          repository: open-edge-platform/orch-cli
          ref: v0.12.26
          path: edge-manageability-framework/orch-cli
          persist-credentials: false

      - name: Checkout edge-manage-test-automation repository with submodules
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: open-edge-platform/edge-manage-test-automation
          path: edge-manageability-framework/edge-manage-test-automation
          ref: ${{ steps.read-test-automation-version.outputs.version }}
          submodules: 'recursive'
          token: ${{ secrets.SYS_ORCH_GITHUB }}
          persist-credentials: false

      - name: Install DNSmasq
        run: |
          pwd
          cd ci/cli-ven
          ./dnsmasq-setup.sh "kind.internal" setup

      - name: Install Libvirt
        env:
          LIBVIRT_DEFAULT_URI: 'qemu:///system'
        run: |
          cd ci/cli-ven
          ./libvirt-setup.sh
          sudo usermod -aG libvirt $(whoami)
          # Grant access to libvirt sockets (works immediately, no logout needed)
          sudo chmod 666 /var/run/libvirt/libvirt-sock || true
          sudo chmod 666 /var/run/libvirt/libvirt-sock-ro || true
          # Restart libvirtd to refresh socket
          sudo systemctl restart libvirtd || true
          virsh list --all || true
          virsh pool-list --all || true
          sudo apt update
          sudo apt install xsltproc -y

      - name: Config DNSmasq
        run: |
          cd ci/cli-ven
          ./dnsmasq-setup.sh "kind.internal" config

       - name: Install orch-cli
        run: |
          cd orch-cli
          ls -lrt
          make build
          make install

      - name: Setup a virtual environment
        run: |
          cd edge-manage-test-automation
          make asdf-install
          make venv_edge-manage-test-automation

          # install required versions for Pico
          pushd repos/ven/pico
          asdf install
          popd

      - name: Set serial numbers dynamically
        id: set-serials
        run: |
          echo "VEN1_SERIAL_NUMBER=PICOVENSN001" >> $GITHUB_ENV
          echo "VEN2_SERIAL_NUMBER=PICOVENSN002" >> $GITHUB_ENV

      - name: Create HOST NIO Registration
        if: ${{ always() && steps.deploy-kind-orchestrator.conclusion == 'success' && steps.default-mt-setup.conclusion == 'success' }}
        shell: bash
        timeout-minutes: 5
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          cd ci/cli-ven
          
          ./host-config-cli.sh login
          ./host-config-cli.sh create-region-site
          ./host-config-cli.sh list-region-site
          ./host-config-cli.sh get-profile
          ./host-config-cli.sh host-nio-registration "${VEN1_SERIAL_NUMBER}" "${VEN2_SERIAL_NUMBER}"
          orch-cli list hosts
