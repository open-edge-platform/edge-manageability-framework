# SPDX-FileCopyrightText: 2026 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

name: Virtual Integration

on:
  # Allow manually triggering the workflow
  workflow_dispatch: {}
  # Run on all commits that are pushed to all branches
  push:
    branches:
      - main
      - main-pass-validation

  # Trigger workflow on PRs to all branches
  pull_request:
    branches:
      - "*"
    types:
      - opened
      - synchronize
      - reopened
  # Trigger workflow when enqueued to a merge group
  merge_group:

# For PRs â†’ use the PR number as the group (forces only 1 run active)
# For branches â†’ use the full ref (unique per branch) so runs don't cancel each other
concurrency:
  group: ${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  checks: read

jobs:
  pre-merge:
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    uses: open-edge-platform/orch-ci/.github/workflows/pre-merge.yml@467367d6f859a4654f2645ca78efd60035cf390c  # 2026.0.8
    with:
      run_version_check: false
      run_build: false
      run_lint: false
      run_test: false
      bootstrap_tools: ""
      trivy_config_path: trivy.yaml

  check-changed-files:
    permissions:
      contents: read
    name: Filter list of changed files
    runs-on: ubuntu-latest
    outputs:
      ci: ${{ contains(steps.check-files.outputs.changed_files, '.github/workflows') || contains(steps.check-files.outputs.changed_files, '.github/actions') }}
      go: ${{ contains(steps.check-files.outputs.changed_files, '.go') || contains(steps.check-files.outputs.changed_files, '.mod') || contains(steps.check-files.outputs.changed_files, '.sum') }}
      markdown: ${{ contains(steps.check-files.outputs.changed_files, '.md') || contains(steps.check-files.outputs.changed_files, '.markdown') || contains(steps.check-files.outputs.changed_files, '.mdx') }}
      orch: ${{ contains(steps.check-files.outputs.changed_files, 'argocd') || contains(steps.check-files.outputs.changed_files, 'bootstrap') || contains(steps.check-files.outputs.changed_files, 'installer') || contains(steps.check-files.outputs.changed_files, 'internal') || contains(steps.check-files.outputs.changed_files, 'mage') || contains(steps.check-files.outputs.changed_files, 'node') || contains(steps.check-files.outputs.changed_files, 'router') || contains(steps.check-files.outputs.changed_files, 'tools') || contains(steps.check-files.outputs.changed_files, 'e2e-tests') || contains(steps.check-files.outputs.changed_files, 'VERSION') || contains(steps.check-files.outputs.changed_files, 'orch-configs') }}
      on-prem: ${{ contains(steps.check-files.outputs.changed_files, 'on-prem-installers') || contains(steps.check-files.outputs.changed_files, 'terraform') }}
      on-prem-oxm: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/applications/configs/infra-') ||
        contains(steps.check-files.outputs.changed_files, 'argocd/applications/custom/infra-') ||
        contains(steps.check-files.outputs.changed_files, 'argocd/applications/templates/infra-') ||
        contains(steps.check-files.outputs.changed_files, 'argocd/applications/values.yaml') ||
        contains(steps.check-files.outputs.changed_files, 'on-prem-installers') ||
        contains(steps.check-files.outputs.changed_files, 'orch-configs') ||
        contains(steps.check-files.outputs.changed_files, 'installer/generate_cluster_yaml.sh') }}
      onboarding: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/applications/templates/infra-') || contains(steps.check-files.outputs.changed_files, 'argocd/applications/values.yaml') }}
      shell: ${{ contains(steps.check-files.outputs.changed_files, '.sh') || contains(steps.check-files.outputs.changed_files, '.bash') }}
      terraform: ${{ contains(steps.check-files.outputs.changed_files, '.hcl') || contains(steps.check-files.outputs.changed_files, '.tf') || contains(steps.check-files.outputs.changed_files, '.tfvars') }}
      yaml: ${{ contains(steps.check-files.outputs.changed_files, '.yaml') || contains(steps.check-files.outputs.changed_files, '.yml') }}
      helm: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/') || contains(steps.check-files.outputs.changed_files, 'argocd-internal/') }}
      test-automation: ${{ contains(steps.check-files.outputs.changed_files, '.test-dependencies.yaml') }}
      only_design_proposals: ${{ steps.only-design-proposals.outputs.only_design_proposals }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Discover Changed Files
        id: check-files
        uses: open-edge-platform/orch-ci/discover-changed-files@467367d6f859a4654f2645ca78efd60035cf390c  # 2026.0.8 # zizmor: ignore[unpinned-uses]
        with:
          project_folder: "."

      - name: Calculate only_design_proposals
        id: only-design-proposals
        run: |
          files="${{ steps.check-files.outputs.changed_files }}"
          only_design=true
          # Remove brackets and quotes, then split on comma
          clean_files=$(echo "$files" | sed 's/\[//;s/\]//;s/"//g')
          for file in $(echo "$clean_files" | tr ',' '\n'); do
            file=$(echo $file | xargs) # trim whitespace
            if [[ $file != design-proposals/* ]]; then
              only_design=false
              break
            fi
          done
          echo "only_design=$only_design"
          echo "only_design_proposals=$only_design" >> $GITHUB_OUTPUT

  scan-viruses:
    permissions:
      contents: read
    name: Scan for viruses
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      OUTPUT_FILE: antivirus-report.txt
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Upload evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: antivirus-report
          path: ${{ env.OUTPUT_FILE }}

  lint-markdown:
    permissions:
      contents: read
    name: Lint Markdown
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.markdown == 'true' ||  github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        if: github.event_name != 'merge_group'
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_EMF_GH_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage -v lint:markdown

  lint-shell:
    permissions:
      contents: read
    name: Lint shell scripts
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.shell == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        working-directory: on-prem-installers
        run: shellcheck ***/*.sh

  lint-terraform:
    permissions:
      contents: read
    name: Lint Terraform
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.terraform == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage lint:terraform

  lint-yaml:
    permissions:
      contents: read
    name: Lint YAML
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.yaml == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Configure yamllint pip packages
        run: echo "ASDF_YAMLLINT_PIP_PACKAGES=pyyaml" >> $GITHUB_ENV

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]  
      - name: Run lint
        run: mage lint:yaml

  lint-helm:
    permissions:
      contents: read
    name: Lint Helm
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.helm == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage lint:helm

  lint-go:
    permissions:
      contents: read
    name: Lint Go
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.go == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_EMF_GH_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage lint:golang

  lint-version:
    permissions:
      contents: read
    name: Lint version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          # Fetch all history for all tags and branches
          fetch-depth: 0
          persist-credentials: false

      - name: Prepare ci tools
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: open-edge-platform/orch-ci
          token: ${{ secrets.SYS_EMF_GH_TOKEN }}
          path: orch-ci
          persist-credentials: false

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_EMF_GH_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: |
          orch-ci/scripts/version-check.sh
          mage version:checkVersion

  build-publish:
    permissions:
      contents: read
    name: Build and publish artifacts
    needs:
      - lint-go
      - lint-markdown
      - lint-shell
      - lint-terraform
      - lint-helm
      - lint-yaml
      - lint-version
      - scan-viruses
      - check-changed-files
    if: |
      always() &&
      needs.lint-version.result == 'success' && (
      needs.check-changed-files.outputs.orch == 'true' ||
      needs.check-changed-files.outputs.on-prem == 'true' ||
      needs.check-changed-files.outputs.ci == 'true' ||
      needs.check-changed-files.outputs.test-automation == 'true' ||
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/main-pass-validation'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      deb-version: ${{ steps.set-version.outputs.DEB_VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false
          ref:  ${{ github.event.pull_request.head.sha }}

      - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        if: github.event_name != 'merge_group'
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_EMF_GH_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Get version tag
        id: get_version_tag
        run: |
          output=$(mage version:getVersionTag)
          echo "versionTag=$output" >> $GITHUB_ENV

      - name: Build DEB packages
        working-directory: on-prem-installers
        run: mage build:all

      - name: Set DEB_VERSION
        id: set-version
        working-directory: on-prem-installers
        run: |
          mage build:debVersion
          echo "DEB_VERSION=$(mage build:debVersion)" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722  # v4.0.1
        with:
          aws-access-key-id: ${{ secrets.NO_AUTH_ECR_PUSH_USERNAME }}
          aws-secret-access-key: ${{ secrets.NO_AUTH_ECR_PUSH_PASSWD }}
          aws-region: us-west-2

      - name: Login to ECR
        run: aws ecr get-login-password --region us-west-2 | oras login -u AWS --password-stdin 080137407410.dkr.ecr.us-west-2.amazonaws.com

      - name: Publish on-prem installer artifacts
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        working-directory: on-prem-installers
        run: mage publish:all

      - name: Publish Orchestrator source code artifacts
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        run: mage publish:sourceTarballs

      - name: Login to ECR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772  # v3.4.0
        with:
          registry: 080137407410.dkr.ecr.us-west-2.amazonaws.com

      - name: Build Cloud Installer and release bundle artifacts
        run: |
          mage installer:build
          mage installer:bundle

      - name: Scan Cloud Installer Image
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5  # v0.30.0
        with:
          image-ref: 080137407410.dkr.ecr.us-west-2.amazonaws.com/edge-orch/common/orchestrator-installer-cloudfull:${{ env.versionTag }}
          format: table
          output: "trivy-orchestrator-installer-cloudfull.txt"
          ignore-unfixed: true

      - name: Calculate MD5 Checksum
        id: checksum
        run: |
          md5sum_value=$(md5sum "trivy-orchestrator-installer-cloudfull.txt" | cut -d " " -f 1)
          echo "md5sum is $md5sum_value"
          echo "md5sum_value=$md5sum_value" >> "$GITHUB_ENV"

      - name: Upload Trivy Image Scan Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: trivy-scan-report-orchestrator-installer-cloudfull-${{ env.md5sum_value }}
          path: trivy-orchestrator-installer-cloudfull.txt

      - name: Publish Cloud Installer artifact
        if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
        run: mage publish:cloudInstaller

      - name: Build release manifest artifact
        if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
        run: |
          mkdir -p release-manifest
          mage -v gen:releaseManifest release-manifest/chart-manifest.yaml
          mage -v gen:releaseImageManifest release-manifest/image-manifest.yaml

      - name: Publish release manifest artifact
        if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
        run: |
          mage publish:releaseManifest

  # ============================================================================
  # TEMPORARY VALIDATION JOB - Remove after validation is complete
  # This job embeds diagnostics convergence validation for testing purposes
  # ============================================================================
  diagnostics-convergence-validation:
    name: Diagnostics Convergence Validation (TEMPORARY)
    permissions:
      actions: read
      contents: read
    # Always run, but do early exit if all target jobs succeeded
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Check if convergence analysis is needed
        id: check-need-analysis
        run: |          
          # Check if at least one job is non-success (failure, cancelled, etc.)
          need_analysis=true
          
          echo "need_analysis=$need_analysis" >> $GITHUB_OUTPUT
          
          if [[ "$need_analysis" == "false" ]]; then
            echo "âœ… All target jobs succeeded. Convergence analysis skipped."
            echo "## Convergence Analysis Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All target deploy jobs succeeded, so convergence analysis was not needed." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "ðŸ” At least one job had issues. Proceeding with convergence analysis."

      - name: Checkout repository
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Python
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: '3.11'

      - name: List recent workflow runs
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        id: list-runs
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            // Number of recent runs to analyze for convergence
            const MAX_RUNS = 20;
            
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'virtual-integration.yml',
              per_page: MAX_RUNS,
              status: 'completed'
            });
            
            core.info(`Found ${runs.data.workflow_runs.length} completed workflow runs`);
            
            // Extract run IDs and metadata
            const runData = runs.data.workflow_runs.map(run => ({
              id: run.id,
              number: run.run_number,
              event: run.event,
              status: run.status,
              conclusion: run.conclusion,
              created_at: run.created_at
            }));
            
            // Save to output file for next step
            const fs = require('fs');
            fs.writeFileSync('workflow_runs.json', JSON.stringify(runData, null, 2));
            
            return runData;

      - name: Download diagnostics artifacts
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read workflow runs from previous step
            const runData = JSON.parse(fs.readFileSync('workflow_runs.json', 'utf8'));
            
            // Create artifacts directory
            const artifactsDir = 'downloaded-artifacts';
            fs.mkdirSync(artifactsDir, { recursive: true });
            
            const targetJobs = ['deploy-kind', 'deploy-on-prem', 'deploy-oxm-profile'];
            let downloadedCount = 0;
            let totalAttempted = 0;
            
            // Number of recent runs to analyze (should match MAX_RUNS above)
            const MAX_RUNS = 20;
            
            // Download artifacts from recent runs
            for (const run of runData.slice(0, MAX_RUNS)) {
              core.info(`\nChecking run #${run.number} (ID: ${run.id})`);
              
              try {
                const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: run.id
                });
                
                for (const artifact of artifacts.data.artifacts) {
                  // Check if artifact matches our target pattern
                  for (const job of targetJobs) {
                    if (artifact.name.startsWith(`diagnostics-${job}-`)) {
                      totalAttempted++;
                      core.info(`  Found artifact: ${artifact.name}`);
                      
                      try {
                        // Download artifact
                        const download = await github.rest.actions.downloadArtifact({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          artifact_id: artifact.id,
                          archive_format: 'zip'
                        });
                        
                        // Save to file
                        const artifactPath = path.join(artifactsDir, `${artifact.name}.zip`);
                        fs.writeFileSync(artifactPath, Buffer.from(download.data));
                        downloadedCount++;
                        
                        core.info(`  âœ“ Downloaded ${artifact.name}`);
                      } catch (downloadError) {
                        core.warning(`  âœ— Failed to download ${artifact.name}: ${downloadError.message}`);
                      }
                      
                      break;
                    }
                  }
                }
              } catch (error) {
                core.warning(`Failed to list artifacts for run ${run.id}: ${error.message}`);
              }
            }
            
            core.info(`\nðŸ“Š Download summary: ${downloadedCount}/${totalAttempted} artifacts downloaded`);
            
            // Save summary for next step
            fs.writeFileSync('download_summary.json', JSON.stringify({
              downloaded: downloadedCount,
              attempted: totalAttempted
            }, null, 2));

      - name: Extract and organize artifacts
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        run: |
          mkdir -p extracted-artifacts
          cd downloaded-artifacts
          
          # Extract all downloaded artifacts
          for zipfile in *.zip; do
            if [[ -f "$zipfile" ]]; then
              echo "Extracting $zipfile..."
              artifact_name="${zipfile%.zip}"
              mkdir -p "../extracted-artifacts/$artifact_name"
              unzip -q "$zipfile" -d "../extracted-artifacts/$artifact_name"
            fi
          done
          
          cd ..
          echo "Extracted artifacts:"
          find extracted-artifacts -name "diagnostics_full_*.json" -type f

      - name: Run convergence analysis
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        run: |
          echo "Running diagnostics convergence analysis..."
          
          # Check if we have any artifacts to analyze
          json_count=$(find extracted-artifacts -name "diagnostics_full_*.json" -type f | wc -l)
          echo "Found $json_count diagnostics JSON files"
          
          if [[ $json_count -eq 0 ]]; then
            echo "âš ï¸  No diagnostics data found. Creating empty convergence report."
            mkdir -p convergence-output
            echo '{"status": "no_data", "message": "No diagnostics artifacts found", "total_runs": 0}' > convergence-output/convergence.json
            echo "# No Diagnostics Data Available" > convergence-output/convergence.md
            echo "No diagnostics artifacts were found for analysis." >> convergence-output/convergence.md
            echo '{"total_artifacts": 0, "artifacts": []}' > convergence-output/manifest.json
          else
            # Run the convergence analyzer
            python3 ci/diagnostics_convergence.py extracted-artifacts --output-dir convergence-output
          fi
          
          echo "Convergence analysis complete!"
          ls -lh convergence-output/

      - name: Upload convergence outputs
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: convergence-analysis-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            convergence-output/convergence.json
            convergence-output/convergence.md
            convergence-output/manifest.json
          retention-days: 15
          compression-level: 6

      - name: Write summary to GITHUB_STEP_SUMMARY
        if: steps.check-need-analysis.outputs.need_analysis == 'true'
        run: |
          echo "## ðŸ“Š Diagnostics Convergence Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Include the markdown report
          if [[ -f convergence-output/convergence.md ]]; then
            cat convergence-output/convergence.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Convergence report not generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This is a temporary validation job - will be removed after validation*" >> $GITHUB_STEP_SUMMARY

  tag-repo:
    permissions:
      contents: read
    name: Tag repo
    needs:
      - lint-version
      - build-publish
      - deploy-kind
      - deploy-on-prem
      - deploy-oxm-profile
    if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          # Fetch all history for all tags and branches
          fetch-depth: 0
          persist-credentials: false

      - name: Prepare ci tools
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: open-edge-platform/orch-ci
          token: ${{ secrets.SYS_EMF_GH_TOKEN }}
          path: orch-ci
          persist-credentials: false

      - name: Tag repo
        env:
          GITHUB_TOKEN: ${{ secrets.SYS_EMF_GH_TOKEN }}
        run: orch-ci/scripts/version-tag.sh

  post-merge:
    permissions:
      contents: read
      security-events: write
      id-token: write
    if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
    uses: open-edge-platform/orch-ci/.github/workflows/post-merge.yml@467367d6f859a4654f2645ca78efd60035cf390c  # 2026.0.8
    with:
      run_build: false
      run_version_tag: false
    secrets:
      SYS_EMF_GH_TOKEN: ${{ secrets.SYS_EMF_GH_TOKEN }}
      NO_AUTH_ECR_PUSH_USERNAME: ${{ secrets.NO_AUTH_ECR_PUSH_USERNAME }}
      NO_AUTH_ECR_PUSH_PASSWD: ${{ secrets.NO_AUTH_ECR_PUSH_PASSWD }}
      MSTEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}
