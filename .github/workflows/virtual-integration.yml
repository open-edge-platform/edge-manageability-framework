# SPDX-FileCopyrightText: 2025 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0

name: Virtual Integration

on:
  # Allow manually triggering the workflow
  workflow_dispatch: {}
  # Run on all commits that are pushed to all branches
  push:
    branches:
      - main
      - main-pass-validation

  # Trigger workflow on PRs to all branches
  pull_request:
    branches:
      - "*"
    types:
      - opened
      - synchronize
      - reopened
  # Trigger workflow when enqueued to a merge group
  merge_group:

# Only run at most 1 workflow concurrently per PR, unlimited for branches
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions: {}

jobs:
  pre-merge:
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    uses: open-edge-platform/orch-ci/.github/workflows/pre-merge.yml@c4b86434962d13f65fd7b16a33e9eecfd5849a64  # 0.1.56
    with:
      run_version_check: false
      run_build: false
      run_lint: false
      run_test: false
      bootstrap_tools: ""
      trivy_config_path: trivy.yaml

  check-changed-files:
    permissions:
      contents: read
    name: Filter list of changed files
    runs-on: ubuntu-latest
    outputs:
      ci: ${{ contains(steps.check-files.outputs.changed_files, '.github/workflows') || contains(steps.check-files.outputs.changed_files, '.github/actions') }}
      go: ${{ contains(steps.check-files.outputs.changed_files, '.go') || contains(steps.check-files.outputs.changed_files, '.mod') || contains(steps.check-files.outputs.changed_files, '.sum') }}
      markdown: ${{ contains(steps.check-files.outputs.changed_files, '.md') || contains(steps.check-files.outputs.changed_files, '.markdown') || contains(steps.check-files.outputs.changed_files, '.mdx') }}
      orch: ${{ contains(steps.check-files.outputs.changed_files, 'argocd') || contains(steps.check-files.outputs.changed_files, 'bootstrap') || contains(steps.check-files.outputs.changed_files, 'installer') || contains(steps.check-files.outputs.changed_files, 'internal') || contains(steps.check-files.outputs.changed_files, 'mage') || contains(steps.check-files.outputs.changed_files, 'node') || contains(steps.check-files.outputs.changed_files, 'router') || contains(steps.check-files.outputs.changed_files, 'tools') || contains(steps.check-files.outputs.changed_files, 'e2e-tests') || contains(steps.check-files.outputs.changed_files, 'VERSION') || contains(steps.check-files.outputs.changed_files, 'orch-configs') }}
      on-prem: ${{ contains(steps.check-files.outputs.changed_files, 'on-prem-installers') || contains(steps.check-files.outputs.changed_files, 'terraform') }}
      onboarding: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/applications/templates/infra-') || contains(steps.check-files.outputs.changed_files, 'argocd/applications/values.yaml') }}
      shell: ${{ contains(steps.check-files.outputs.changed_files, '.sh') || contains(steps.check-files.outputs.changed_files, '.bash') }}
      terraform: ${{ contains(steps.check-files.outputs.changed_files, '.hcl') || contains(steps.check-files.outputs.changed_files, '.tf') || contains(steps.check-files.outputs.changed_files, '.tfvars') }}
      yaml: ${{ contains(steps.check-files.outputs.changed_files, '.yaml') || contains(steps.check-files.outputs.changed_files, '.yml') }}
      helm: ${{ contains(steps.check-files.outputs.changed_files, 'argocd/') || contains(steps.check-files.outputs.changed_files, 'argocd-internal/') }}
      test-automation: ${{ contains(steps.check-files.outputs.changed_files, '.test-dependencies.yaml') }}
      only_design_proposals: ${{ steps.only-design-proposals.outputs.only_design_proposals }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Discover Changed Files
        id: check-files
        uses: open-edge-platform/orch-ci/discover-changed-files@main  # zizmor: ignore[unpinned-uses]
        with:
          project_folder: "."

      - name: Calculate only_design_proposals
        id: only-design-proposals
        run: |
          files="${{ steps.check-files.outputs.changed_files }}"
          only_design=true
          # Remove brackets and quotes, then split on comma
          clean_files=$(echo "$files" | sed 's/\[//;s/\]//;s/"//g')
          for file in $(echo "$clean_files" | tr ',' '\n'); do
            file=$(echo $file | xargs) # trim whitespace
            if [[ $file != design-proposals/* ]]; then
              only_design=false
              break
            fi
          done
          echo "only_design=$only_design"
          echo "only_design_proposals=$only_design" >> $GITHUB_OUTPUT

  scan-viruses:
    permissions:
      contents: read
    name: Scan for viruses
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      OUTPUT_FILE: antivirus-report.txt
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: ClamAV
        run: |
          docker run --rm \
          --mount type=bind,source=./,target=/scandir \
          clamav/clamav:stable \
          clamscan --recursive --log=/scandir/${{ env.OUTPUT_FILE }} \
          /scandir

          if [ $? -ne 0 ]; then
            sudo chown $USER:$USER ${{ env.OUTPUT_FILE }}
            exit 1
          fi
          sudo chown $USER:$USER ${{ env.OUTPUT_FILE }}

      - name: Upload evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: antivirus-report
          path: ${{ env.OUTPUT_FILE }}

  lint-markdown:
    permissions:
      contents: read
    name: Lint Markdown
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.markdown == 'true' ||  github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_ORCH_GITHUB }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage -v lint:markdown

  lint-shell:
    permissions:
      contents: read
    name: Lint shell scripts
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.shell == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        working-directory: on-prem-installers
        run: shellcheck ***/*.sh

  lint-terraform:
    permissions:
      contents: read
    name: Lint Terraform
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.terraform == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage lint:terraform

  lint-yaml:
    permissions:
      contents: read
    name: Lint YAML
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.yaml == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Configure yamllint pip packages
        run: echo "ASDF_YAMLLINT_PIP_PACKAGES=pyyaml" >> $GITHUB_ENV

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]
        
      - name: Run lint
        run: mage lint:yaml

  lint-helm:
    permissions:
      contents: read
    name: Lint Helm
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.helm == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage lint:helm

  lint-go:
    permissions:
      contents: read
    name: Lint Go
    needs:
      - check-changed-files
    if: needs.check-changed-files.outputs.go == 'true' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_ORCH_GITHUB }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: mage lint:golang

  lint-version:
    permissions:
      contents: read
    name: Lint version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          # Fetch all history for all tags and branches
          fetch-depth: 0
          persist-credentials: false

      - name: Prepare ci tools
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: open-edge-platform/orch-ci
          path: orch-ci
          persist-credentials: false

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_ORCH_GITHUB }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Run lint
        run: |
          orch-ci/scripts/version-check.sh
          mage version:checkVersion

  build-publish:
    permissions:
      contents: read
    name: Build and publish artifacts
    needs:
      - lint-go
      - lint-markdown
      - lint-shell
      - lint-terraform
      - lint-helm
      - lint-yaml
      - lint-version
      - scan-viruses
      - check-changed-files
    if: |
      always() &&
      needs.lint-version.result == 'success' && (
      needs.check-changed-files.outputs.orch == 'true' ||
      needs.check-changed-files.outputs.on-prem == 'true' ||
      needs.check-changed-files.outputs.ci == 'true' ||
      needs.check-changed-files.outputs.test-automation == 'true' ||
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/main-pass-validation'
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      deb-version: ${{ steps.set-version.outputs.DEB_VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false
          ref:  ${{ github.event.pull_request.head.sha }}

      - uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up git credentials
        shell: bash
        run: |
          echo "GOPRIVATE=github.com/open-edge-platform" >> $GITHUB_ENV
          git config --global url."https://${{ secrets.SYS_ORCH_GITHUB }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Setup asdf and install dependencies
        uses: open-edge-platform/orch-utils/.github/actions/setup-asdf@main  # zizmor: ignore[unpinned-uses]

      - name: Get version tag
        id: get_version_tag
        run: |
          output=$(mage version:getVersionTag)
          echo "versionTag=$output" >> $GITHUB_ENV

      - name: Build DEB packages
        working-directory: on-prem-installers
        run: mage build:all

      - name: Set DEB_VERSION
        id: set-version
        working-directory: on-prem-installers
        run: |
          mage build:debVersion
          echo "DEB_VERSION=$(mage build:debVersion)" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722  # v4.0.1
        with:
          aws-access-key-id: ${{ secrets.NO_AUTH_ECR_PUSH_USERNAME }}
          aws-secret-access-key: ${{ secrets.NO_AUTH_ECR_PUSH_PASSWD }}
          aws-region: us-west-2

      - name: Login to ECR
        run: aws ecr get-login-password --region us-west-2 | oras login -u AWS --password-stdin 080137407410.dkr.ecr.us-west-2.amazonaws.com

      - name: Publish on-prem installer artifacts
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        working-directory: on-prem-installers
        run: mage publish:all

      - name: Publish Orchestrator source code artifacts
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        run: mage publish:sourceTarballs

      - name: Login to ECR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772  # v3.4.0
        with:
          registry: 080137407410.dkr.ecr.us-west-2.amazonaws.com

      - name: Build Cloud Installer and release bundle artifacts
        run: |
          mage installer:build
          mage installer:bundle

      - name: Scan Cloud Installer Image
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5  # v0.30.0
        with:
          image-ref: 080137407410.dkr.ecr.us-west-2.amazonaws.com/edge-orch/common/orchestrator-installer-cloudfull:${{ env.versionTag }}
          format: table
          output: "trivy-orchestrator-installer-cloudfull.txt"
          ignore-unfixed: true

      - name: Calculate MD5 Checksum
        id: checksum
        run: |
          md5sum_value=$(md5sum "trivy-orchestrator-installer-cloudfull.txt" | cut -d " " -f 1)
          echo "md5sum is $md5sum_value"
          echo "md5sum_value=$md5sum_value" >> "$GITHUB_ENV"

      - name: Upload Trivy Image Scan Report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: trivy-scan-report-orchestrator-installer-cloudfull-${{ env.md5sum_value }}
          path: trivy-orchestrator-installer-cloudfull.txt

      - name: Publish Cloud Installer artifact
        if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
        run: mage publish:cloudInstaller

      - name: Build release manifest artifact
        if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
        run: |
          mkdir -p release-manifest
          mage -v gen:releaseManifest release-manifest/chart-manifest.yaml
          mage -v gen:releaseImageManifest release-manifest/image-manifest.yaml

      - name: Publish release manifest artifact
        if: github.event_name == 'push' && ( github.ref == 'refs/heads/main' || github.ref == 'refs/heads/main-pass-validation' )
        run: |
          mage publish:releaseManifest

  deploy-kind:
    permissions:
      contents: read
    name: Deploy Kind Orchestrator and run tests
    needs:
      - lint-go
      - lint-markdown
      - lint-shell
      - lint-terraform
      - lint-version
      - lint-helm
      - lint-yaml
      - check-changed-files
    if: |
      always() &&
      needs.lint-version.result == 'success' &&
      needs.check-changed-files.outputs.only_design_proposals != 'true' && (
      needs.check-changed-files.outputs.orch == 'true' ||
      needs.check-changed-files.outputs.ci == 'true' ||
      github.ref == 'refs/heads/main' ||
      github.ref == 'refs/heads/main-pass-validation'
      )
    runs-on: ubuntu-24.04-16core-64GB
    timeout-minutes: 90
    env:
      ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Checkout virtual-edge-node repo
        uses: actions/checkout@v4
        with:
          repository: open-edge-platform/virtual-edge-node
          ref: pico/1.5.6
          path: $HOME/virtual-edge-node
          persist-credentials: false

      - name: Checkout orch-cli repo
        uses: actions/checkout@v4
        with:
          repository: open-edge-platform/orch-cli
          ref: v0.12.26
          path: edge-manageability-framework/orch-cli
          persist-credentials: false

      - name: Checkout edge-manage-test-automation repository with submodules
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: open-edge-platform/edge-manage-test-automation
          path: edge-manageability-framework/edge-manage-test-automation
          ref: ${{ steps.read-test-automation-version.outputs.version }}
          submodules: 'recursive'
          token: ${{ secrets.SYS_ORCH_GITHUB }}
          persist-credentials: false

      - name: Install DNSmasq
        run: |
          pwd
          cd ci/cli-ven
          ./dnsmasq-setup.sh "kind.internal" setup

      - name: Install Libvirt
        env:
          LIBVIRT_DEFAULT_URI: 'qemu:///system'
        run: |
          cd ci/cli-ven
          ./libvirt-setup.sh
          sudo usermod -aG libvirt $(whoami)
          # Grant access to libvirt sockets (works immediately, no logout needed)
          sudo chmod 666 /var/run/libvirt/libvirt-sock || true
          sudo chmod 666 /var/run/libvirt/libvirt-sock-ro || true
          # Restart libvirtd to refresh socket
          sudo systemctl restart libvirtd || true
          virsh list --all || true
          virsh pool-list --all || true
          sudo apt update
          sudo apt install xsltproc -y

      - name: Deploy Kind Orchestrator
        id: deploy-kind-orchestrator
        uses: ./.github/actions/deploy_kind
        timeout-minutes: 45
        with:
          orch_version: ${{ github.event.pull_request.head.sha || github.sha }}
          orch_password: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
          docker_username: ${{ secrets.SYS_DOCKERHUB_USERNAME }}
          docker_password: ${{ secrets.SYS_DOCKERHUB_RO }}
          token: ${{ secrets.SYS_ORCH_GITHUB }}
          deployment_type: all

      - name: Collect diagnostics
        if: always()
        uses: ./.github/actions/collect_diagnostics
        timeout-minutes: 15

      - name: Config DNSmasq
        run: |
          cd ci/cli-ven
          ./dnsmasq-setup.sh "kind.internal" config

      - name: Run policy compliance tests
        run: mage test:policyCompliance

      - name: Run image pull policy compliance tests
        run: mage test:imagePullPolicyCompliance

      - name: Setup Sample Org and Project with default users
        id: default-mt-setup
        run: mage tenantUtils:createDefaultMtSetup

      - name: Deploy Victoria Metrics instance
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: mage deploy:victoriaMetrics apply

      - name: Run e2e tenancy tests
        run: mage test:e2etenancy

      - name: Run e2e tenancy API gateway tests
        run: mage test:e2etenancyapigw

      - name: Create default user and run e2e tests
        run: mage devUtils:createDefaultUser test:e2e

      - name: "Test Observability SRE Exporter w/o ENiC"
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          mage test:e2eSreObservabilityNoEnic

      - name: Install orch-cli
        run: |
          cp -rf ${GITHUB_WORKSPACE}/orch-cli .
          cd orch-cli
          make build
          make install

      - name: Setup a virtual environment
        run: |
          cp -rf ${GITHUB_WORKSPACE}/edge-manage-test-automation .
          cd edge-manage-test-automation
          make asdf-install
          make venv_edge-manage-test-automation

          # install required versions for Pico
          pushd repos/ven/pico
          asdf install
          popd

      - name: Set serial numbers dynamically
        id: set-serials
        run: |
          echo "VEN1_SERIAL_NUMBER=PICOVENSN001" >> $GITHUB_ENV
          echo "VEN2_SERIAL_NUMBER=PICOVENSN002" >> $GITHUB_ENV

      - name: Create HOST NIO Registration
        if: ${{ always() && steps.deploy-kind-orchestrator.conclusion == 'success' && steps.default-mt-setup.conclusion == 'success' }}
        shell: bash
        timeout-minutes: 5
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          cd ci/cli-ven
          ./host-config-cli.sh login
          ./host-config-cli.sh create-region-site
          ./host-config-cli.sh list-region-site
          ./host-config-cli.sh get-profile
          ./host-config-cli.sh host-nio-registration "${VEN1_SERIAL_NUMBER}" "${VEN2_SERIAL_NUMBER}"
          orch-cli list hosts

      - name: VEN Onboard EdgeNode
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          cd ci/cli-ven
          ./pico-ven.sh create "${VEN1_SERIAL_NUMBER}" "${VEN2_SERIAL_NUMBER}"
          ./host-config-cli.sh host-status "${VEN1_SERIAL_NUMBER}" "${VEN2_SERIAL_NUMBER}"

      - name: Get VEN UUID from script
        id: get-uuid
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          cd ci/cli-ven
          ./host-config-cli.sh login
          VEN1_UUID=$(./get-uuid-by-sn.sh "${VEN1_SERIAL_NUMBER}")
          VEN2_UUID=$(./get-uuid-by-sn.sh "${VEN2_SERIAL_NUMBER}")
          echo "VEN1_UUID=$VEN1_UUID" >> $GITHUB_ENV
          echo "VEN2_UUID=$VEN2_UUID" >> $GITHUB_ENV
          echo "ven1_uuid=$VEN1_UUID" >> $GITHUB_OUTPUT
          echo "ven2_uuid=$VEN2_UUID" >> $GITHUB_OUTPUT

      - name: Run AO / CO smoke test
        if: ${{ always() && steps.deploy-kind-orchestrator.conclusion == 'success' && steps.default-mt-setup.conclusion == 'success' }}
        env:
          PROJECT: sample-project
          NODE_UUID: ${{ env.VEN1_UUID }}
          EDGE_MGR_USER: sample-project-edge-mgr
          EDGE_INFRA_USER: sample-project-api-user
        run: |
          echo "Running AO / CO smoke test..."
          mage test:clusterOrchSmokeTest

      - name: UI E2E Tests
        if: ${{ always() && steps.deploy-kind-orchestrator.conclusion == 'success' && steps.default-mt-setup.conclusion == 'success' }}
        uses: ./.github/actions/cypress
        with:
          token: ${{ secrets.SYS_ORCH_GITHUB }}
          en_serial_number: ${{ env.VEN2_SERIAL_NUMBER }}
          en_uuid: ${{ env.VEN2_UUID }}
          infra: "cypress/e2e/infra/locations.cy.ts,cypress/e2e/infra/new-host-provision.cy.ts,cypress/e2e/infra/verify-host.cy.ts"

      - name: "Test Observability Public Endpoints"
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          mage test:e2eObservability

      - name: "Test Observability Orchestrator Stack"
        env:
          ORCH_DEFAULT_PASSWORD: ${{ secrets.ORCH_DEFAULT_PASSWORD }}
        run: |
          mage test:e2eOrchObservability

      - name: Collect smoke test logs
        if: always()
        run: |
          mkdir -p smoke-test/logs
          kubectl logs -n orch-app -l app=app-deployment-api -c app-deployment-api --tail=-1 > smoke-test/logs/app-deployment-api.log
          kubectl logs -n orch-app -l app=app-deployment-manager --tail=-1 > smoke-test/logs/app-deployment-manager.log
          kubectl logs -n orch-app -l app=app-resource-manager -c app-resource-manager --tail=-1 > smoke-test/logs/app-resource-manager.log
          kubectl logs -n orch-app -l app.kubernetes.io/name=app-orch-catalog --tail=-1 > smoke-test/logs/application-catalog.log

      - name: Setup VEN virtual environment
        working-directory: edge-manage-test-automation
        run: |
          make asdf-install
          make venv_edge-manage-test-automation

          # install required versions for Pico
          pushd repos/ven/pico
          asdf install
          popd

      - name: Run Golden Suite Robot Framework Tests
        id: robot-tests
        timeout-minutes: 45
        working-directory: edge-manage-test-automation
        env:
          REQUESTS_CA_BUNDLE: /usr/local/share/ca-certificates/orch-ca.crt
          LIBVIRT_DEFAULT_URI: 'qemu:///system'
        run: |
          virsh list --all || true
          virsh pool-list --all || true
          kubectl get node || true
          kubectl -n orch-platform get secrets platform-keycloak -o yaml || true
          KC_ADMIN_PWD=$(kubectl -n keycloak-system get secrets platform-keycloak -o jsonpath='{.data.password}' | base64 -d)

          # Add the password to the orchestrator config
          yq eval ".orchestrator.admin_password = \"${KC_ADMIN_PWD}\"" -i orchestrator-configs/kind.yaml
          yq eval '.infra.host.edgenode.hw_info.libvirt_pool_name = "default"'    -i tests/core_foundation/data/cf_data_1_ven_VEN-libvirt_microvisor-nonrt.yaml
          yq eval '.infra.host.edgenode.hw_info.libvirt_network_name = "default"' -i tests/core_foundation/data/cf_data_1_ven_VEN-libvirt_microvisor-nonrt.yaml
          cat tests/core_foundation/data/cf_data_1_ven_VEN-libvirt_microvisor-nonrt.yaml || true
          source venv_edge-manage-test-automation/bin/activate
          robot -L DEBUG --pythonpath . \
            --name "Golden Suite: Core Foundation" \
            -d robot_output/core_foundation \
            -V orchestrator-configs/kind.yaml \
            --exitonfailure \
            --exclude cf6 \
            --exclude cf8 \
            tests/core_foundation/core_foundation.robot

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: on-prem-${{ github.event_name }}-${{ github.event.number }}-robot-report
          path: |
            edge-manage-test-automation/robot_output/**/*
